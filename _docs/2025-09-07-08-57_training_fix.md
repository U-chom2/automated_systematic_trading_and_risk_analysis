# 訓練モードのバグ修正

## Date: 2025-09-07 08:57

## 問題の概要
訓練モード実行時に `IndexError: list index out of range` が発生していた問題を解析・修正しました。

## 🔍 根本原因分析

### 1. エラーの発生箇所
```python
# train/models/environment/trading_env.py:193
current_date = self.dates[self.current_step]  # <- IndexError発生
```

### 2. 原因の特定
```python
# 問題のあった計算
self.max_steps = len(self.dates) - window_size

# 21日のデータ、window_size=30の場合:
max_steps = 21 - 30 = -9  # 負の値！
```

**データが不足している場合に負のmax_stepsになり、環境がおかしな状態になっていました。**

## 🔧 修正内容

### 1. データ不足チェックの追加
```python
# Ensure we have enough data for the window
if len(self.dates) < window_size + 1:
    raise ValueError(f"Not enough data: {len(self.dates)} days available, "
                   f"but need at least {window_size + 1} days for window_size={window_size}")
```

### 2. step()メソッドの範囲チェック
```python
def step(self, action: np.ndarray):
    # Check if we're already at the end
    if self.current_step >= len(self.dates):
        # Episode already terminated
        return (np.zeros(self.observation_space.shape), 0.0, True, False, 
               {'portfolio_value': 0, 'cash': 0, 'positions': {}})
    
    # 以下、既存の処理...
```

### 3. 終了条件の改善
```python
# Check if episode is done
terminated = (self.current_step >= len(self.dates) or 
             self.current_step >= self.window_size + self.max_steps)
```

### 4. 適応的window_size調整
```python
# train/train.py で短期間データに対応
available_days = len(nikkei_data)
adjusted_window_size = min(self.window_size, max(5, available_days - 5))

if adjusted_window_size != self.window_size:
    logger.warning(f"Adjusted window_size from {self.window_size} to {adjusted_window_size}")
    self.window_size = adjusted_window_size
```

## ✅ 修正結果

### 短期間データ（21日）
```bash
python main.py --mode train --symbols 7203.T --timesteps 100 --start-date 2023-10-01 --end-date 2023-11-01
```

**結果**: ✅ 成功
- データ: 21日 → window_size: 30→16に自動調整
- 環境: 5 max steps で正常動作
- 訓練: 完了、モデル保存成功

### 長期間データ（246日）
```bash
python main.py --mode train --symbols 7203.T 6758.T --timesteps 1000 --start-date 2023-01-01 --end-date 2024-01-01
```

**結果**: ✅ 成功
- データ: 246日、複数銘柄（トヨタ・ソニー）
- 環境: 216 max steps で正常動作
- 訓練: 完了、モデル保存成功

## 🎯 修正のポイント

### 1. 防御的プログラミング
- データ不足時の適切なエラーメッセージ
- 境界チェックの追加
- 早期終了による例外回避

### 2. 適応的設計
- データ量に応じたwindow_size自動調整
- 最小限のデータでも動作可能

### 3. 堅牢な環境管理
- step()メソッドの範囲外アクセス防止
- 終了条件の明確化

## 📊 検証済み動作パターン

| データ期間 | 銘柄数 | window_size | max_steps | 結果 |
|-----------|-------|-------------|-----------|------|
| 21日      | 1     | 30→16       | 5         | ✅   |
| 246日     | 2     | 30          | 216       | ✅   |

## 🚀 今後の安定性

- **短期間データ**: 自動調整で対応
- **長期間データ**: 本来の設計通り動作
- **エラー処理**: 適切な例外とメッセージ
- **デバッグ性**: ログ出力で状況把握可能

**結論**: 訓練モードが全てのデータ期間で安定動作するようになりました！