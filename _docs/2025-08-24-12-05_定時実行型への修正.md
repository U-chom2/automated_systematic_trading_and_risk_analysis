# 定時実行型システムへの修正

**実装日時**: 2025年8月24日 12:05
**実装者**: Claude Code (Opus 4.1)
**対応要件**: 要件定義書 16:15定時実行対応

## 実装概要

AIデイトレードシステムを、リアルタイム反応型から**毎日16:15定時実行型**に修正しました。

### 主な変更点

1. **設計思想の変更**
   - リアルタイム反応システム → 定時分析・判定システム
   - 即座の検知・反応 → 1日の総合分析による翌日投資判断

2. **実行スケジュール**
   - **毎日16:15**: 定時分析開始（データ収集・分析・投資判断）
   - **翌営業日9:00**: 自動取引執行

## 1. 要件定義書の修正

### システム概要（2.1）
```markdown
変更前: リアルタイム反応システム
変更後: 定時分析・判定システム

毎日16:15（取引終了後）に、その日の株価変動要因（カタリスト）を
総合的に分析し、翌日の投資判断を決定する。
```

### 機能要件の修正

| ID | 変更前 | 変更後 |
|:---|:-------|:-------|
| FR-02 | リアルタイムデータ収集 | **定時データ収集**（16:15実行） |
| FR-03 | カタリスト検知（トリガー） | **カタリスト情報分析**（定時分析） |
| FR-04 | トリガー発生後分析 | **総合分析機能**（16:15定時実行） |
| FR-07 | 自動取引執行 | **翌日朝一番取引執行**（9:00実行） |

### 非機能要件の修正

| ID | 変更前 | 変更後 |
|:---|:-------|:-------|
| NFR-01 | 5秒以内処理 | **30分以内処理**（16:15-16:45） |
| NFR-02 | 取引時間中稼働 | **定時実行時稼働**（16:15） |

## 2. WorkflowManager の修正

### 新しいフェーズ定義

```python
class TradingPhase(Enum):
    IDLE = "IDLE"
    DATA_COLLECTION = "DATA_COLLECTION"  # 16:15 - データ収集
    ANALYSIS = "ANALYSIS"  # 分析フェーズ
    DECISION = "DECISION"  # 投資判断フェーズ
    PENDING_EXECUTION = "PENDING_EXECUTION"  # 翌日執行待機
    EXECUTION = "EXECUTION"  # 翌日朝執行フェーズ
    COMPLETED = "COMPLETED"  # 処理完了
```

### 新しいデータ構造

```python
@dataclass
class DailyDataCollectionResult:
    """Daily data collection result."""
    collection_date: datetime
    symbols: List[str]
    ir_announcements: List[Dict[str, Any]]
    sns_mentions: Dict[str, int]
    market_data: Dict[str, Any]
    success: bool
    errors: List[str]

@dataclass
class DailyAnalysisResult:
    """Daily comprehensive analysis result."""
    analysis_date: datetime
    symbol: str
    catalyst_score: int  # Max 50
    sentiment_score: int  # Max 30
    market_env_score: int  # Max 20
    total_score: int  # Max 100
    buy_decision: bool
    filter_passed: bool
    filter_reasons: List[str]
    position_size: Optional[int]
    entry_price: Optional[Decimal]
    stop_loss_price: Optional[Decimal]
    take_profit_price: Optional[Decimal]

@dataclass
class NextDayExecutionPlan:
    """Next day execution plan."""
    execution_date: datetime
    buy_targets: List[DailyAnalysisResult]
    total_capital_allocation: Decimal
    risk_per_trade: Decimal
```

### 主要メソッド

```python
async def run_daily_analysis(self) -> bool:
    """毎日16:15に実行される定時分析"""
    # Phase 1: Data Collection
    collection_result = await self.collect_daily_data()
    
    # Phase 2: Analysis
    analysis_results = await self.analyze_collected_data(collection_result)
    
    # Phase 3: Decision
    execution_plan = await self.make_trading_decisions(analysis_results)
    
    # Save execution plan for next day
    self.next_day_plan = execution_plan

async def execute_morning_trades(self) -> bool:
    """翌日朝9:00に実行される取引執行"""
    for target in self.next_day_plan.buy_targets:
        # Place buy order
        # Set OCO order (Stop Loss / Take Profit)
```

## 3. 定時実行フロー

### 16:15 定時分析フロー

```
16:15 開始
├── データ収集フェーズ
│   ├── IR情報収集（TDnet、各社HP）
│   ├── SNS情報収集（X、Yahoo掲示板）
│   └── 市場データ収集（株価、出来高）
│
├── 分析フェーズ
│   ├── カタリスト重要度分析（0-50点）
│   ├── センチメント分析（0-30点）
│   └── 市場環境分析（0-20点）
│
├── 投資判断フェーズ
│   ├── 総合スコアリング（Max 100点）
│   ├── フィルター適用（RSI、移動平均乖離率）
│   └── 買い判断（80点以上かつフィルター通過）
│
└── 実行計画保存
    └── NextDayExecutionPlan
```

### 翌日9:00 取引執行フロー

```
9:00 開始
├── 実行計画読み込み
├── 各銘柄の買い注文実行
├── OCO注文設定（利益確定・損切り）
└── ポジション追跡開始
```

## 4. スケジューリング機能

```python
def is_scheduled_time(self) -> bool:
    """16:15の定時実行時間チェック"""
    scheduled_datetime = datetime.combine(datetime.today(), time(16, 15))
    time_diff = abs((datetime.now() - scheduled_datetime).total_seconds())
    return time_diff <= 60  # 1分以内

def is_execution_time(self) -> bool:
    """9:00の朝一番執行時間チェック"""
    execution_datetime = datetime.combine(datetime.today(), time(9, 0))
    time_diff = abs((datetime.now() - execution_datetime).total_seconds())
    return time_diff <= 60  # 1分以内
```

## 5. パフォーマンス要件の変更

### 変更前
- IRトリガー検知から注文執行まで**5秒以内**
- リアルタイム処理優先

### 変更後
- 定時実行開始から分析完了まで**30分以内**（16:15-16:45）
- 包括的分析優先
- 処理時間測定機能実装

```python
# 処理時間測定
start_time = datetime.now()
# ... 処理実行 ...
processing_time = (datetime.now() - start_time).total_seconds() / 60
self.metrics["average_processing_time_minutes"] = processing_time
```

## 6. 今後の実装課題

### 優先度：高
1. **スケジューラー実装**
   - cronジョブまたはスケジューラーライブラリ導入
   - 東証営業日カレンダー連携

2. **データコレクター修正**
   - バッチ処理最適化
   - 1日分データの効率的収集

3. **実行管理修正**
   - 翌日朝の自動執行機能
   - 前場寄り付き注文対応

### 優先度：中
4. **永続化機能**
   - 実行計画のDB保存
   - 障害復旧対応

5. **通知機能**
   - 分析完了通知
   - 取引執行結果通知

6. **バックテスト対応**
   - 過去データでの検証機能
   - パラメータ最適化

## まとめ

要件定義書の変更に基づき、システムを定時実行型に修正しました。主な成果：

- ✅ 要件定義書を16:15定時実行に合わせて修正
- ✅ WorkflowManagerを定時実行型に再設計
- ✅ 新しいデータ構造とフェーズ定義を実装
- ✅ 定時分析・翌日執行のフロー実装
- ✅ パフォーマンス要件を30分以内処理に変更

システムは毎日16:15に包括的な分析を行い、翌日朝9:00に自動取引を実行する設計に変更されました。