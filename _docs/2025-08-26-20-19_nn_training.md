# ニューラルネットワーク（リスクモデル）訓練環境構築完了
作成日時: 2025-08-26 20:19

## 📊 実装内容

### ✅ 既存実装の確認
- `src/analysis_engine/risk_model.py`に以下が実装済み：
  - `RiskNeuralNetwork`: PyTorch実装の3層NN（6→32→16→1）
  - `RiskModel`: 訓練・予測を行うラッパークラス
  - `train()`メソッド: 訓練ロジック実装済み

### 🆕 新規作成した訓練環境

#### 1. **ディレクトリ構造**
```
train/
├── generate_training_data.py      # 米国株訓練データ生成
├── generate_japan_training_data.py # 日本株訓練データ生成
├── train_risk_model.py            # モデル訓練スクリプト
├── test_model.py                  # モデルテスト・検証
├── run_training.sh                # 自動実行スクリプト
├── README.md                      # ドキュメント
└── data/                         # 生成データ格納
    └── models/                   # 訓練済みモデル格納
```

#### 2. **訓練データ生成機能**
- **入力特徴量（6次元）**：
  - ヒストリカル・ボラティリティ（HV）
  - ATR（Average True Range）
  - RSI（相対力指数）
  - 出来高比率
  - 移動平均乖離率
  - ベータ値（市場感応度）

- **出力**：
  - 最適な損切り幅（1%〜15%）

- **データソース**：
  - 米国主要20銘柄（AAPL, MSFT, GOOGL等）
  - 日本株30銘柄（ターゲット企業.xlsxから）

#### 3. **訓練機能**
- **ネットワーク構造**：
  - 入力層：6ユニット
  - 隠れ層1：32ユニット（ReLU活性化）
  - 隠れ層2：16ユニット（ReLU活性化）
  - 出力層：1ユニット（Sigmoid活性化）
  - Dropout：0.2（過学習防止）

- **訓練設定**：
  - 最適化：Adam（学習率0.001）
  - 損失関数：MSE（平均二乗誤差）
  - エポック数：最大200（早期停止あり）
  - バッチサイズ：32

#### 4. **検証・テスト機能**
- 様々な市場シナリオでのテスト
- 検証データでの精度評価
- 予測vs実測のプロット生成
- R²、MAE、RMSEの計算

## 🎯 使用方法

### 簡単な実行（推奨）
```bash
cd train
./run_training.sh
```

### 手動実行
```bash
# 1. データ生成（米国株）
uv run python generate_training_data.py

# 2. データ生成（日本株）
uv run python generate_japan_training_data.py

# 3. モデル訓練
uv run python train_risk_model.py

# 4. モデルテスト
uv run python test_model.py
```

## 📈 期待される成果

### モデル性能目標
- **MAE（平均絶対誤差）**: < 2%
- **R²スコア**: > 0.6
- **検証損失**: < 0.001

### 実用上の利点
1. **動的な損切り幅設定**：市場の状態に応じて最適な損切り幅を自動調整
2. **リスク管理の改善**：ボラティリティに応じた適切なポジションサイジング
3. **損失の最小化**：過度に狭い/広い損切りを回避

## 🔧 本番環境への統合

訓練済みモデルは以下のように使用：

```python
from src.analysis_engine.risk_model import RiskModel

# モデルロード
risk_model = RiskModel()
risk_model.load_model('train/models/risk_model.pth')

# 予測実行
features = {
    'historical_volatility': 0.25,
    'atr': 14.5,
    'rsi': 65,
    'volume_ratio': 1.5,
    'ma_deviation': 0.08,
    'beta': 1.2
}

prediction = risk_model.predict(features)
stop_loss_pct = prediction.stop_loss_percentage
```

## 📝 次のステップ

1. **モデル訓練の実行**
   - `./run_training.sh`で自動訓練
   - 約30分で完了予定

2. **本番環境への統合**
   - 訓練済みモデルをTargetSelectorに統合
   - ポジションサイジング計算での活用

3. **継続的改善**
   - 実取引データでの再訓練
   - ハイパーパラメータのチューニング
   - 特徴量エンジニアリング

## ⚠️ 注意事項

- 初回のデータ生成には20-30分かかる場合があります
- インターネット接続が必要（Yahoo Finance API使用）
- GPUがない場合、訓練に時間がかかります（30分程度）

## 💡 Tips

- 日本株に特化した訓練：`generate_japan_training_data.py`を使用
- 米国株と日本株の混合データ：`combined_train_data.json`が自動生成される
- 過学習の兆候が見られたら、Dropoutを増やすか、隠れ層のサイズを減らす